<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArtNet Sender Monitor Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .debug-button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        .debug-button:hover {
            background: #c82333;
        }
        .debug-button.active {
            background: #28a745;
        }
        .debug-controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
        }
        .debug-controls.active {
            display: block;
        }
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .debug-section h3 {
            margin-top: 0;
            color: #333;
        }
        .debug-section.active {
            border-color: #28a745;
            background: #f8fff9;
        }
        .color-picker {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .radio-group {
            margin: 10px 0;
        }
        .radio-group label {
            margin-right: 15px;
            cursor: pointer;
        }
        .slider-container {
            margin: 10px 0;
        }
        .slider-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .slider {
            width: 100%;
            margin: 5px 0;
        }
        .slider-value {
            font-family: monospace;
            font-weight: bold;
            color: #667eea;
        }
        .debug-status {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
        }
        .debug-status.active {
            background: #d4edda;
            color: #155724;
        }
        .debug-status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .activate-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .activate-btn:hover {
            background: #218838;
        }
        .activate-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .disable-all-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 10px;
        }
        .disable-all-btn:hover {
            background: #c82333;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            text-align: center;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .modal-btn.confirm {
            background: #dc3545;
            color: white;
        }
        .modal-btn.cancel {
            background: #6c757d;
            color: white;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .controller-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .controller-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-connected {
            color: green;
            font-weight: bold;
        }
        .status-disconnected {
            color: red;
            font-weight: bold;
        }
        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .refresh-btn:hover {
            background: #5a6fd8;
        }
        .error-details {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .cooldown-info {
            background: #fffbf0;
            border: 1px solid #f6e05e;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .status-cooldown {
            color: orange;
            font-weight: bold;
        }
        .status-connecting {
            color: orange;
            font-weight: bold;
        }
        .compact-view {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        .compact-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .compact-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .compact-ip {
            font-family: monospace;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .compact-status {
            font-size: 12px;
            font-weight: bold;
        }
        .view-toggle {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .view-toggle:hover {
            background: #5a6fd8;
        }
        .controller-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .controller-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .controller-card.collapsed {
            padding: 15px;
        }
        .controller-card.collapsed .details {
            display: none;
        }
        .controller-card.expanded .details {
            display: block;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé¨ ArtNet Sender Monitor</h1>
        <p>Real-time monitoring of ArtNet controller status and system performance</p>
    </div>

    <button id="debugButton" class="debug-button" onclick="toggleDebugMode()">üî¥ DEBUG MODE</button>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Enter Debug Mode?</h3>
            <p>Debug mode will pause the normal render loop and allow you to control the display directly. This may interrupt any running scenes.</p>
            <div class="modal-buttons">
                <button class="modal-btn confirm" onclick="confirmDebugMode()">Enter Debug Mode</button>
                <button class="modal-btn cancel" onclick="cancelDebugMode()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="debugControls" class="debug-controls">
        <div class="debug-section" id="mappingSection">
            <h3>üéØ Mapping Tester</h3>
            <div class="slider-container">
                <label>Target:</label>
                <select id="mappingTarget" onchange="updateSliderRange(); updateMappingTester()">
                    <option value="world">World Raster</option>
                </select>
            </div>
            <div class="radio-group">
                <label><input type="radio" name="orientation" value="xy" checked onchange="updateSliderRange(); updateMappingTester()"> XY Plane</label>
                <label><input type="radio" name="orientation" value="xz" onchange="updateSliderRange(); updateMappingTester()"> XZ Plane</label>
                <label><input type="radio" name="orientation" value="yz" onchange="updateSliderRange(); updateMappingTester()"> YZ Plane</label>
            </div>
            <div class="slider-container">
                <label>Layer: <span id="layerValue" class="slider-value">0</span></label>
                <input type="range" id="layerSlider" class="slider" min="0" max="19" value="0" oninput="updateMappingTester()">
            </div>
            <div class="slider-container">
                <label>Color:</label>
                <input type="color" id="mappingColor" class="color-picker" value="#FF0000" onchange="updateMappingTester()">
            </div>
            <div class="button-group">
                <button id="mappingActivateBtn" class="activate-btn" onclick="activateMappingTester()">ACTIVATE</button>
            </div>
            <div id="mappingStatus" class="debug-status"></div>
        </div>

        <div class="debug-section" id="powerSection">
            <h3>‚ö° Power Draw Tester</h3>
            <div class="slider-container">
                <label>Color:</label>
                <input type="color" id="powerColor" class="color-picker" value="#00FF00" onchange="updatePowerDrawTester()">
            </div>
            <div class="radio-group">
                <label><input type="radio" name="modulation" value="sin" checked onchange="updatePowerDrawTester()"> Sine Wave</label>
                <label><input type="radio" name="modulation" value="square" onchange="updatePowerDrawTester()"> Square Wave</label>
            </div>
            <div class="slider-container">
                <label>Frequency: <span id="freqValue" class="slider-value">1.0</span> Hz</label>
                <input type="range" id="freqSlider" class="slider" min="0.1" max="10.0" step="0.1" value="1.0" oninput="updatePowerDrawTester()">
            </div>
            <div class="slider-container">
                <label>Amplitude: <span id="ampValue" class="slider-value">0.5</span></label>
                <input type="range" id="ampSlider" class="slider" min="0.0" max="1.0" step="0.1" value="0.5" oninput="updatePowerDrawTester()">
            </div>
            <div class="slider-container">
                <label>Offset: <span id="offsetValue" class="slider-value">0.5</span></label>
                <input type="range" id="offsetSlider" class="slider" min="0.0" max="1.0" step="0.1" value="0.5" oninput="updatePowerDrawTester()">
            </div>
            <div class="slider-container">
                <label>Global Brightness: <span id="brightnessValue" class="slider-value">1.0</span></label>
                <input type="range" id="brightnessSlider" class="slider" min="0.0" max="1.0" step="0.1" value="1.0" oninput="updatePowerDrawTester()">
            </div>
            <div class="button-group">
                <button id="powerActivateBtn" class="activate-btn" onclick="activatePowerDrawTester()">ACTIVATE</button>
            </div>
            <div id="powerStatus" class="debug-status"></div>
        </div>

        <div class="debug-section">
            <h3>‚è∏Ô∏è Playback Control</h3>
            <button id="pauseButton" onclick="togglePause()" style="background: #ffc107; color: black; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">‚è∏Ô∏è Pause</button>
            <div id="pauseStatus" class="debug-status"></div>
        </div>

        <button id="disableAllBtn" class="disable-all-btn" onclick="disableAllDebugCommands()">DISABLE ALL DEBUG COMMANDS</button>
    </div>

    <button class="refresh-btn" onclick="refreshData()">üîÑ Refresh Data</button>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="fps">--</div>
            <div class="stat-label">Current FPS</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="uptime">--</div>
            <div class="stat-label">Uptime</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-frames">--</div>
            <div class="stat-label">Total Frames</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="routable-controllers">--</div>
            <div class="stat-label">Routable Controllers</div>
        </div>
    </div>

    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button class="view-toggle" onclick="toggleView('compact')">üì± Compact View</button>
        <button class="view-toggle" onclick="toggleView('detailed')">üìã Detailed View</button>
    </div>

    <div id="compact-view" class="compact-view" style="display: none;">
        <!-- Compact view will be populated here -->
    </div>

    <div id="detailed-view">
        <h2>üéõÔ∏è Controller Status</h2>
        <div class="controller-grid" id="controller-grid">
            <div class="controller-card">
                <p>Loading controller data...</p>
            </div>
        </div>
    </div>

    <script>
        let debugMode = false;
        let isPaused = false;
        let activeDebugCommand = null; // 'mapping_tester' or 'power_draw_tester' or null
        let updateTimeout = null;
        let worldDimensions = { width: 20, height: 20, length: 20 }; // Default fallback
        let cubeList = []; // List of available cubes

        // Fetch world dimensions and update slider range
        async function fetchWorldDimensions() {
            try {
                const response = await fetch('/api/debug/world-dimensions');
                const data = await response.json();
                if (data.width && data.height && data.length) {
                    worldDimensions = data;
                    updateSliderRange();
                }
            } catch (error) {
                console.error('Error fetching world dimensions:', error);
            }
        }

        // Fetch cube list and populate dropdown
        async function fetchCubeList() {
            try {
                const response = await fetch('/api/debug/cubes');
                const data = await response.json();
                if (Array.isArray(data)) {
                    cubeList = data;
                    populateCubeDropdown();
                }
            } catch (error) {
                console.error('Error fetching cube list:', error);
            }
        }

        function populateCubeDropdown() {
            const dropdown = document.getElementById('mappingTarget');
            // Clear existing options except "World Raster"
            dropdown.innerHTML = '<option value="world">World Raster</option>';

            // Add cube options
            cubeList.forEach((cube, index) => {
                const option = document.createElement('option');
                option.value = `cube_${index}`;
                option.textContent = cube.id;
                dropdown.appendChild(option);
            });
        }

        function updateSliderRange() {
            const layerSlider = document.getElementById('layerSlider');
            const orientation = document.querySelector('input[name="orientation"]:checked').value;
            const target = document.getElementById('mappingTarget').value;

            let maxValue;
            let dimensions;

            if (target === 'world') {
                dimensions = worldDimensions;
            } else if (target.startsWith('cube_')) {
                const cubeIndex = parseInt(target.split('_')[1]);
                if (cubeIndex >= 0 && cubeIndex < cubeList.length) {
                    const cube = cubeList[cubeIndex];
                    dimensions = {
                        width: cube.dimensions[0],
                        height: cube.dimensions[1],
                        length: cube.dimensions[2]
                    };
                } else {
                    dimensions = worldDimensions; // fallback
                }
            } else {
                dimensions = worldDimensions; // fallback
            }

            switch (orientation) {
                case 'xy':
                    maxValue = dimensions.length - 1; // Z-axis
                    break;
                case 'xz':
                    maxValue = dimensions.height - 1; // Y-axis
                    break;
                case 'yz':
                    maxValue = dimensions.width - 1; // X-axis
                    break;
                default:
                    maxValue = 19; // fallback
            }

            layerSlider.max = maxValue;
            if (parseInt(layerSlider.value) > maxValue) {
                layerSlider.value = maxValue;
                document.getElementById('layerValue').textContent = maxValue;
            }
        }

        // Slider value updates
        document.getElementById('layerSlider').addEventListener('input', function() {
            document.getElementById('layerValue').textContent = this.value;
        });

        document.getElementById('freqSlider').addEventListener('input', function() {
            document.getElementById('freqValue').textContent = this.value;
        });

        document.getElementById('ampSlider').addEventListener('input', function() {
            document.getElementById('ampValue').textContent = this.value;
        });

        document.getElementById('offsetSlider').addEventListener('input', function() {
            document.getElementById('offsetValue').textContent = this.value;
        });

        document.getElementById('brightnessSlider').addEventListener('input', function() {
            document.getElementById('brightnessValue').textContent = this.value;
        });

        function toggleDebugMode() {
            if (!debugMode) {
                // Show confirmation modal
                document.getElementById('confirmModal').style.display = 'block';
            } else {
                // Exit debug mode directly
                exitDebugMode();
            }
        }

        function confirmDebugMode() {
            document.getElementById('confirmModal').style.display = 'none';
            enterDebugMode();
        }

        function cancelDebugMode() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        function enterDebugMode() {
            debugMode = true;
            const button = document.getElementById('debugButton');
            const controls = document.getElementById('debugControls');

            button.textContent = 'üü¢ DEBUG MODE ACTIVE';
            button.classList.add('active');
            controls.classList.add('active');
            sendDebugMode(true);
        }

        function exitDebugMode() {
            debugMode = false;
            const button = document.getElementById('debugButton');
            const controls = document.getElementById('debugControls');

            button.textContent = 'üî¥ DEBUG MODE';
            button.classList.remove('active');
            controls.classList.remove('active');
            sendDebugMode(false);

            // Disable all debug commands when exiting
            disableAllDebugCommands();
        }

        function disableAllDebugCommands() {
            activeDebugCommand = null;

            // Update UI
            document.getElementById('mappingSection').classList.remove('active');
            document.getElementById('powerSection').classList.remove('active');
            document.getElementById('mappingActivateBtn').disabled = false;
            document.getElementById('powerActivateBtn').disabled = false;

            // Clear status messages
            document.getElementById('mappingStatus').textContent = '';
            document.getElementById('mappingStatus').className = 'debug-status';
            document.getElementById('powerStatus').textContent = '';
            document.getElementById('powerStatus').className = 'debug-status';

            // Send disable command
            sendDisableAllCommands();
        }

        function activateMappingTester() {
            activeDebugCommand = 'mapping_tester';

            // Update UI
            document.getElementById('mappingSection').classList.add('active');
            document.getElementById('powerSection').classList.remove('active');
            document.getElementById('mappingActivateBtn').disabled = true;
            document.getElementById('powerActivateBtn').disabled = false;

            // Send the command
            updateMappingTester();
        }

        function activatePowerDrawTester() {
            activeDebugCommand = 'power_draw_tester';

            // Update UI
            document.getElementById('mappingSection').classList.remove('active');
            document.getElementById('powerSection').classList.add('active');
            document.getElementById('mappingActivateBtn').disabled = false;
            document.getElementById('powerActivateBtn').disabled = true;

            // Send the command
            updatePowerDrawTester();
        }

        function updateMappingTester() {
            if (activeDebugCommand !== 'mapping_tester') return;

            const orientation = document.querySelector('input[name="orientation"]:checked').value;
            const layer = parseInt(document.getElementById('layerSlider').value);
            const color = document.getElementById('mappingColor').value;
            const target = document.getElementById('mappingTarget').value;
            const status = document.getElementById('mappingStatus');

            // Send immediately for instant response
            sendMappingTester(orientation, layer, color, target, status);
        }

        function updatePowerDrawTester() {
            if (activeDebugCommand !== 'power_draw_tester') return;

            const color = document.getElementById('powerColor').value;
            const modulationType = document.querySelector('input[name="modulation"]:checked').value;
            const frequency = parseFloat(document.getElementById('freqSlider').value);
            const amplitude = parseFloat(document.getElementById('ampSlider').value);
            const offset = parseFloat(document.getElementById('offsetSlider').value);
            const globalBrightness = parseFloat(document.getElementById('brightnessSlider').value);
            const status = document.getElementById('powerStatus');

            // Debounce the updates
            if (updateTimeout) clearTimeout(updateTimeout);
            updateTimeout = setTimeout(() => {
                sendPowerDrawTester(color, modulationType, frequency, amplitude, offset, globalBrightness, status);
            }, 100);
        }

        async function sendDebugMode(enabled) {
            try {
                const response = await fetch('/api/debug/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                const result = await response.json();
                console.log('Debug mode result:', result);
            } catch (error) {
                console.error('Error setting debug mode:', error);
            }
        }

        async function sendDisableAllCommands() {
            try {
                // Send a command to clear all debug commands
                const response = await fetch('/api/debug/mapping-tester', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clear: true })
                });
                console.log('Disable all commands result:', response);
            } catch (error) {
                console.error('Error disabling all commands:', error);
            }
        }

        async function togglePause() {
            isPaused = !isPaused;
            const button = document.getElementById('pauseButton');
            const status = document.getElementById('pauseStatus');

            if (isPaused) {
                button.textContent = '‚ñ∂Ô∏è Resume';
                button.style.background = '#28a745';
                status.textContent = 'Status: Paused - Render loop stopped';
            } else {
                button.textContent = '‚è∏Ô∏è Pause';
                button.style.background = '#ffc107';
                status.textContent = 'Status: Playing - Render loop active';
            }

            try {
                const response = await fetch('/api/debug/pause', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paused: isPaused })
                });
                const result = await response.json();
                console.log('Pause result:', result);
            } catch (error) {
                console.error('Error setting pause:', error);
            }
        }

        async function sendMappingTester(orientation, layer, color, target, status) {
            try {
                const response = await fetch('/api/debug/mapping-tester', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orientation, layer, color, target })
                });
                const result = await response.json();
                if (result.success) {
                    let targetName;
                    if (target === 'world') {
                        targetName = 'World Raster';
                    } else if (target.startsWith('cube_')) {
                        const cubeIndex = parseInt(target.split('_')[1]);
                        targetName = cubeList[cubeIndex]?.id || `Cube ${cubeIndex + 1}`;
                    } else {
                        targetName = target;
                    }
                    status.textContent = `Active: ${orientation.toUpperCase()} plane at layer ${layer} on ${targetName} with color ${color}`;
                    status.className = 'debug-status active';
                } else {
                    status.textContent = `Error: ${result.error}`;
                    status.className = 'debug-status error';
                }
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.className = 'debug-status error';
            }
        }

        async function sendPowerDrawTester(color, modulationType, frequency, amplitude, offset, globalBrightness, status) {
            try {
                const response = await fetch('/api/debug/power-draw-tester', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        color,
                        modulation_type: modulationType,
                        frequency,
                        amplitude,
                        offset,
                        global_brightness: globalBrightness
                    })
                });
                const result = await response.json();
                if (result.success) {
                    status.textContent = `Active: ${modulationType} wave at ${frequency}Hz, amp: ${amplitude}, offset: ${offset}, brightness: ${globalBrightness}, color: ${color}`;
                    status.className = 'debug-status active';
                } else {
                    status.textContent = `Error: ${result.error}`;
                    status.className = 'debug-status error';
                }
            } catch (error) {
                status.textContent = `Error: ${error.message}`;
                status.className = 'debug-status error';
            }
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours}h ${minutes}m ${secs}s`;
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Never';
            const date = new Date(dateString);
            return date.toLocaleString();
        }

        function updateStats(data) {
            document.getElementById('fps').textContent = data.system.fps.toFixed(1);
            document.getElementById('uptime').textContent = formatUptime(data.system.uptime_seconds);
            document.getElementById('total-frames').textContent = data.system.total_frames.toLocaleString();
            document.getElementById('routable-controllers').textContent =
                data.controllers.filter(c => c.is_routable).length + ' / ' + data.controllers.length;
        }

        function updateControllers(data) {
            const grid = document.getElementById('controller-grid');
            grid.innerHTML = '';

            data.controllers.forEach(controller => {
                const card = document.createElement('div');
                card.className = 'controller-card collapsed';
                card.setAttribute('data-ip', controller.ip);

                // Determine status and styling based on the new logic
                let statusClass, statusText, statusIcon;
                if (controller.is_connecting) {
                    statusClass = 'status-connecting';
                    statusText = 'üü° Connecting...';
                    statusIcon = 'üü°';
                } else if (controller.is_routable) {
                    statusClass = 'status-connected';
                    statusText = 'üü¢ Connected';
                    statusIcon = 'üü¢';
                } else {
                    statusClass = 'status-disconnected';
                    statusText = 'üî¥ Disconnected';
                    statusIcon = 'üî¥';
                }

                // Calculate time remaining in cooldown
                let cooldownInfo = '';
                if (controller.cooldown_until && controller.is_connecting) {
                    const cooldownTime = new Date(controller.cooldown_until);
                    const now = new Date();
                    if (cooldownTime > now) {
                        const remainingMs = cooldownTime - now;
                        const remainingSeconds = Math.ceil(remainingMs / 1000);
                        cooldownInfo = `<div class="cooldown-info">
                            <strong>‚è∞ Cooldown Active:</strong> ${remainingSeconds}s remaining before connection attempt
                        </div>`;
                    } else {
                        // Cooldown expired, show transition message
                        cooldownInfo = `<div class="cooldown-info">
                            <strong>‚úÖ Cooldown Complete:</strong> Controller will transition to Connected on next successful transmission
                        </div>`;
                    }
                }

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleCard(this.parentElement)">
                        <h3>${controller.ip}:${controller.port}</h3>
                        <span class="${statusClass}">${statusText}</span>
                        <span style="font-size: 20px;">üìã</span>
                    </div>
                    <div class="details">
                        <p><strong>Last Success:</strong> ${formatDateTime(controller.last_success)}</p>
                        <p><strong>Last Failure:</strong> ${formatDateTime(controller.last_failure)}</p>
                        <p><strong>Failure Count:</strong> ${controller.failure_count}</p>
                        ${controller.last_error ? `<div class="error-details"><strong>Last Error:</strong> ${controller.last_error}</div>` : ''}
                        ${cooldownInfo}
                    </div>
                `;

                // Restore expanded state if this card was previously expanded
                if (expandedCards.has(controller.ip)) {
                    card.classList.remove('collapsed');
                    card.classList.add('expanded');
                }

                grid.appendChild(card);
            });
        }

        function toggleCard(card) {
            const ip = card.getAttribute('data-ip');

            if (card.classList.contains('collapsed')) {
                card.classList.remove('collapsed');
                card.classList.add('expanded');
                expandedCards.add(ip); // Remember this card is expanded
            } else {
                card.classList.remove('expanded');
                card.classList.add('collapsed');
                expandedCards.delete(ip); // Remember this card is collapsed
            }
        }

        async function refreshData() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();
                updateStats(data);
                updateControllers(data);
                window.lastData = data; // Store data for compact view update
                updateCompactView(); // Update compact view after stats and controllers are loaded
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Refresh data every 2 seconds
        setInterval(refreshData, 2000);

        // Initial load
        refreshData();

        // View management
        let currentView = 'detailed';
        let expandedCards = new Set(); // Track which cards are expanded

        function toggleView(view) {
            currentView = view;
            const compactView = document.getElementById('compact-view');
            const detailedView = document.getElementById('detailed-view');

            if (view === 'compact') {
                compactView.style.display = 'grid';
                detailedView.style.display = 'none';
                updateCompactView();
            } else {
                compactView.style.display = 'none';
                detailedView.style.display = 'block';
            }
        }

        function updateCompactView() {
            const compactView = document.getElementById('compact-view');
            if (!window.lastData) return;

            compactView.innerHTML = '';

            window.lastData.controllers.forEach(controller => {
                const item = document.createElement('div');
                item.className = 'compact-item';

                // Determine status and styling
                let statusClass, statusText, statusIcon;
                if (controller.is_connecting) {
                    statusClass = 'status-connecting';
                    statusText = 'üü° Connecting...';
                } else if (controller.is_routable) {
                    statusClass = 'status-connected';
                    statusText = 'üü¢ Connected';
                } else {
                    statusClass = 'status-disconnected';
                    statusText = 'üî¥ Disconnected';
                }

                item.innerHTML = `
                    <div class="compact-ip">${controller.ip}</div>
                    <div class="compact-status ${statusClass}">${statusText}</div>
                `;

                // Make compact items clickable to expand details
                item.onclick = () => {
                    toggleView('detailed');
                    // Scroll to the specific controller
                    const controllerCard = document.querySelector(`[data-ip="${controller.ip}"]`);
                    if (controllerCard) {
                        controllerCard.scrollIntoView({ behavior: 'smooth' });
                        // Highlight the controller briefly
                        controllerCard.style.background = '#fff3cd';
                        setTimeout(() => {
                            controllerCard.style.background = 'white';
                        }, 2000);
                    }
                };

                compactView.appendChild(item);
            });
        }

        // Initialize world dimensions and cube list when page loads
        document.addEventListener('DOMContentLoaded', function() {
            fetchWorldDimensions();
            fetchCubeList();
        });
    </script>
</body>
</html>
